<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Nancy Drew: The Case of the Missing Valentine</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
--teal:#0a2a2a;--teal-light:#1a4a4a;--gold:#c9a84c;--gold-light:#e2c97e;
--cream:#f5edd6;--burgundy:#6b1d2a;--burgundy-light:#8b3a4a;
--ink:#2c1810;--amber:rgba(255,180,60,0.15);--hud-bg:rgba(8,32,32,0.92);
}
html,body{width:100%;height:100dvh;overflow:hidden;font-family:Georgia,'Times New Roman',serif;background:#000;color:var(--cream);cursor:default}

/* ===== GAME VIEWPORT ===== */
#game{position:fixed;inset:0;overflow:hidden}
.scene{display:none;position:absolute;inset:0;bottom:60px;overflow:hidden}
.scene.active{display:block}
.scene-bg{position:absolute;inset:0;z-index:0;background-size:cover;background-position:center;background-repeat:no-repeat}
.scene-content{position:absolute;inset:0;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1rem;overflow-y:auto}

/* ===== SCENE BACKGROUND IMAGES ===== */
#scene1 .scene-bg{background-image:url('assets/scene1-detective-office.jpg')}
#scene2 .scene-bg{background-image:url('assets/scene2-pottery-studio.jpg')}
#scene3 .scene-bg{background-image:url('assets/scene3-gymkhana-london.jpg')}
#scene4 .scene-bg{background-image:url('assets/scene4-underwater-kohtao.jpg')}
#scene5 .scene-bg{background-image:url('assets/scene5-dillon-amphitheater.jpg')}
#scene6 .scene-bg{background-image:url('assets/scene6-valentine-room.jpg')}

/* ===== HUD BAR ===== */
#hud{position:fixed;bottom:0;left:0;right:0;height:60px;background:var(--hud-bg);border-top:2px solid rgba(201,168,76,0.4);display:flex;align-items:center;padding:0 12px;z-index:100;gap:8px}
.hud-btn{width:42px;height:42px;background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.3);border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:background 0.2s}
.hud-btn:active{background:rgba(201,168,76,0.25)}
.hud-btn svg{width:22px;height:22px}
#inventory{display:flex;flex:1;gap:6px;justify-content:center;align-items:center;overflow-x:auto;padding:0 8px}
.inv-slot{width:40px;height:40px;background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.15);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.4s}
.inv-slot.filled{border-color:var(--gold);background:rgba(201,168,76,0.12);animation:invPop 0.5s ease}
.inv-slot svg{width:24px;height:24px;opacity:0;transition:opacity 0.4s}
.inv-slot.filled svg{opacity:1}
@keyframes invPop{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}

/* ===== DIALOG BOX ===== */
#dialogOverlay{position:fixed;bottom:60px;left:0;right:0;z-index:90;pointer-events:none;padding:0 8px 8px}
#dialogBox{background:rgba(8,32,32,0.88);border:1px solid rgba(201,168,76,0.3);border-radius:8px;padding:14px 16px 14px 60px;display:none;pointer-events:auto;cursor:pointer;-webkit-tap-highlight-color:transparent;position:relative;min-height:60px;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
#dialogBox.show{display:block;animation:dialogIn 0.3s ease}
@keyframes dialogIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
#dialogIcon{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:36px;height:36px;border-radius:50%;border:1px solid rgba(201,168,76,0.4);display:flex;align-items:center;justify-content:center;background:rgba(201,168,76,0.08)}
#dialogIcon svg{width:20px;height:20px}
#dialogText{font-size:clamp(0.9rem,2.5vw,1rem);line-height:1.6;color:var(--cream)}
#dialogText .speaker{color:var(--gold);font-weight:700;display:block;margin-bottom:2px;font-size:0.85rem;letter-spacing:0.05em;text-transform:uppercase}
.dialog-continue{font-size:0.75rem;color:var(--gold-light);opacity:0.7;margin-top:6px;text-align:right}

/* ===== JOURNAL POPUP ===== */
#journalPopup{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);padding:1rem}
#journalPopup.show{display:flex}
.journal-content{background:linear-gradient(135deg,#1a2a20,#0a1a1a);border:2px solid rgba(201,168,76,0.4);border-radius:10px;padding:1.5rem;max-width:360px;width:100%;max-height:70dvh;overflow-y:auto}
.journal-content h3{font-family:Georgia,serif;color:var(--gold);text-align:center;margin-bottom:1rem;font-size:1.1rem}
.journal-entry{padding:8px 0;border-bottom:1px solid rgba(201,168,76,0.15);font-size:0.9rem;color:var(--cream);opacity:0.8}
.journal-entry.unsolved{opacity:0.4;font-style:italic}
.journal-close{display:block;margin:1rem auto 0;background:none;border:1px solid var(--gold);color:var(--gold);padding:6px 24px;border-radius:4px;cursor:pointer;font-family:Georgia,serif}

/* ===== PHONE POPUP ===== */
#phonePopup{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);padding:1rem}
#phonePopup.show{display:flex}
.phone-content{background:#111;border:2px solid #333;border-radius:20px;padding:2rem 1.5rem;max-width:280px;width:100%;text-align:center}
.phone-content .notif{color:var(--gold);font-size:0.85rem;margin-bottom:0.5rem}
.phone-content .msg{color:var(--cream);font-size:1rem;line-height:1.5;margin:1rem 0}
.phone-close{background:none;border:1px solid #555;color:#aaa;padding:6px 24px;border-radius:20px;cursor:pointer;font-family:Georgia,serif}

/* ===== MEMORY NOTE POPUP ===== */
#memoryPopup{position:fixed;inset:0;z-index:210;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);padding:1rem}
#memoryPopup.show{display:flex}
.memory-content{background:linear-gradient(135deg,#1e1810,#12100c);border:2px solid rgba(201,168,76,0.5);border-radius:12px;padding:0;max-width:360px;width:100%;max-height:75dvh;overflow-y:auto}
.memory-vignette{width:100%;height:160px;background-size:cover;background-position:center;border-radius:12px 12px 0 0;display:none}
.memory-vignette.has-image{display:block}
.memory-text-area{padding:1.5rem}
.memory-title{font-family:Georgia,serif;color:var(--gold);font-size:1.1rem;margin-bottom:0.75rem;text-align:center}
.memory-body{font-family:Georgia,serif;font-size:0.95rem;line-height:1.7;color:var(--cream);opacity:0.9}
.memory-dismiss{display:block;margin:1.25rem auto 0;background:none;border:1px solid var(--gold);color:var(--gold);padding:8px 28px;border-radius:4px;cursor:pointer;font-family:Georgia,serif;font-size:0.9rem}

/* ===== TRANSITION OVERLAY ===== */
#transitionOverlay{position:fixed;inset:0;z-index:150;background:#000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.5s}
#transitionOverlay.show{opacity:1;pointer-events:auto}
#transitionText{color:var(--gold);font-family:Georgia,serif;font-style:italic;font-size:clamp(1rem,3vw,1.2rem);text-align:center}

/* ===== INTERACTIVE HOTSPOT GLOW ===== */
.hotspot{cursor:pointer;-webkit-tap-highlight-color:transparent;transition:filter 0.3s}
@media(hover:hover){.hotspot:hover{filter:brightness(1.3) drop-shadow(0 0 8px rgba(201,168,76,0.5))}}
.hotspot:active{filter:brightness(1.4)}
.hotspot-pulse{animation:hPulse 2s ease-in-out infinite}
@keyframes hPulse{0%,100%{filter:drop-shadow(0 0 4px rgba(201,168,76,0.2))}50%{filter:drop-shadow(0 0 12px rgba(201,168,76,0.5))}}

/* ===== SCENE 1: DETECTIVE OFFICE ===== */
.start-btn{background:rgba(201,168,76,0.15);border:2px solid var(--gold);color:var(--gold);padding:10px 28px;font-family:Georgia,serif;font-size:clamp(0.95rem,2.5vw,1.1rem);letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.3s;border-radius:2px;position:relative;z-index:5}
.start-btn:active{background:rgba(201,168,76,0.3)}

/* ===== SCENE 2: POTTERY ===== */
.pottery-table{position:relative;background:rgba(20,15,10,0.85);border:1px solid rgba(201,168,76,0.2);border-radius:8px;padding:1rem;width:min(340px,92vw);margin-top:0.5rem;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.pottery-prompt{font-family:Georgia,serif;font-size:0.95rem;color:var(--gold-light);text-align:center;margin-bottom:0.75rem;font-style:italic;line-height:1.5}
.pottery-grid{display:flex;gap:6px;justify-content:center;margin-bottom:0.75rem;flex-wrap:wrap}
.shard{width:48px;height:48px;background:rgba(201,168,76,0.08);border:2px solid rgba(201,168,76,0.2);border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:Georgia,serif;font-size:clamp(1.3rem,4vw,1.6rem);font-weight:700;color:var(--gold);user-select:none;transition:all 0.3s}
.shard.empty{border-style:dashed;background:rgba(201,168,76,0.03)}
.shard.placed{background:rgba(201,168,76,0.2);border-color:var(--gold);border-style:solid}
.letter-bank{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:0.5rem}
.letter-tile{width:48px;height:48px;background:linear-gradient(135deg,#3a2010,#5a3420);border:1px solid rgba(201,168,76,0.4);border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:Georgia,serif;font-size:1.2rem;font-weight:700;color:var(--cream);cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;transition:all 0.2s}
.letter-tile:active{transform:scale(0.9)}
.letter-tile.used{opacity:0.2;cursor:default}
.pottery-word{font-family:Georgia,serif;font-size:1.4rem;color:var(--gold);text-align:center;letter-spacing:0.3em;min-height:2rem;margin-top:0.25rem}

/* ===== SCENE 3: GYMKHANA (KARAOKE) ===== */
.karaoke-panel{background:rgba(12,8,4,0.9);border:2px solid rgba(201,168,76,0.3);border-radius:10px;padding:1.5rem;width:min(360px,92vw);max-height:calc(100dvh - 200px);overflow-y:auto;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.karaoke-panel h3{color:var(--gold);text-align:center;font-size:1.15rem;margin-bottom:0.25rem;letter-spacing:0.04em}
.karaoke-panel .karaoke-sub{color:var(--gold-light);text-align:center;font-size:0.85rem;font-style:italic;opacity:0.7;margin-bottom:1.25rem}
.song-option{display:block;width:100%;background:rgba(201,168,76,0.06);border:2px solid rgba(201,168,76,0.2);border-radius:8px;padding:14px 16px;margin-bottom:10px;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.25s;text-align:left;font-family:Georgia,serif;color:var(--cream);font-size:clamp(0.95rem,2.5vw,1.05rem)}
.song-option:active{transform:scale(0.97)}
@media(hover:hover){.song-option:hover{background:rgba(201,168,76,0.12);border-color:rgba(201,168,76,0.4)}}
.song-option.correct-answer{background:rgba(201,168,76,0.25);border-color:var(--gold);color:var(--gold)}
.song-option.wrong-answer{background:rgba(107,29,42,0.3);border-color:var(--burgundy-light)}
.quip-toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(8,32,32,0.95);border:1px solid rgba(201,168,76,0.4);border-radius:8px;padding:12px 20px;font-family:Georgia,serif;font-size:0.9rem;color:var(--cream);max-width:320px;text-align:center;z-index:95;opacity:0;transition:opacity 0.3s;pointer-events:none;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.quip-toast.show{opacity:1}

/* ===== SCENE 4: UNDERWATER ===== */
.adventure-area{position:absolute;inset:0;bottom:0;cursor:none}
.hidden-item{position:absolute;width:80px;height:80px;display:flex;align-items:center;justify-content:center;opacity:0;transition:all 0.4s;cursor:none;-webkit-tap-highlight-color:transparent;border-radius:50%;z-index:5;overflow:hidden}
.hidden-item img{opacity:0;transition:opacity 0.4s}
.hidden-item.near{opacity:0.7;background:rgba(201,168,76,0.3);animation:itemPulse 1s ease-in-out infinite;box-shadow:0 0 20px rgba(201,168,76,0.5)}
.hidden-item.near img{opacity:0.5}
@keyframes itemPulse{0%,100%{transform:scale(1);box-shadow:0 0 15px rgba(201,168,76,0.4)}50%{transform:scale(1.15);box-shadow:0 0 30px rgba(201,168,76,0.7)}}
.hidden-item.found{opacity:1;background:rgba(201,168,76,0.25);border:2px solid var(--gold);animation:invPop 0.5s ease;cursor:pointer}
.hidden-item.found img{opacity:1}
.found-counter{position:absolute;top:12px;right:12px;background:var(--hud-bg);border:1px solid rgba(201,168,76,0.3);border-radius:4px;padding:4px 10px;font-size:0.8rem;color:var(--gold);z-index:5}
.magnify-circle{position:absolute;width:80px;height:80px;border:3px solid var(--gold);border-radius:50%;pointer-events:none;opacity:0;transition:opacity 0.15s;box-shadow:0 0 20px rgba(201,168,76,0.3),inset 0 0 20px rgba(201,168,76,0.1);z-index:10}
.magnify-circle::after{content:'';position:absolute;bottom:-18px;right:-8px;width:4px;height:22px;background:var(--gold);border-radius:2px;transform:rotate(-45deg);transform-origin:top center;opacity:0.8}
.magnify-circle.near-item{box-shadow:0 0 30px rgba(201,168,76,0.6),inset 0 0 25px rgba(201,168,76,0.15);border-color:var(--gold-light)}

/* ===== SCENE 5: DILLON (VW STYLE) ===== */
.stage-area{position:relative;width:min(380px,92vw);margin-top:1rem;background:rgba(10,8,6,0.8);border-radius:10px;padding:1.25rem;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.stage-area .vw-header{font-family:'Futura','Helvetica Neue',Arial,sans-serif;font-size:0.75rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--cream);opacity:0.5;text-align:center;margin-bottom:0.75rem;border-bottom:1px solid rgba(245,237,214,0.15);padding-bottom:0.5rem}
.word-slots{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;min-height:50px;padding:0.75rem;background:rgba(245,237,214,0.03);border:2px solid rgba(245,237,214,0.15);border-radius:4px;margin-bottom:0.75rem}
.word-slot{font-family:'Futura','Helvetica Neue',Arial,sans-serif;font-size:clamp(0.95rem,2.5vw,1.05rem);color:var(--cream);padding:4px 10px;background:rgba(201,168,76,0.15);border-bottom:2px solid var(--cream);cursor:pointer;-webkit-tap-highlight-color:transparent;border-radius:0;transition:all 0.2s;letter-spacing:0.02em}
.word-slot:active{transform:scale(0.9)}
.word-bank{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.word-tile{font-family:'Futura','Helvetica Neue',Arial,sans-serif;font-size:clamp(0.9rem,2.5vw,1rem);color:var(--cream);background:rgba(245,237,214,0.08);border:1px solid rgba(245,237,214,0.2);padding:6px 12px;border-radius:2px;cursor:pointer;-webkit-tap-highlight-color:transparent;user-select:none;transition:all 0.2s;letter-spacing:0.02em}
.word-tile:active{transform:scale(0.9)}
.word-tile.used{opacity:0.2;cursor:default}

/* ===== SCENE 6: VALENTINE ===== */
.love-letter{background:linear-gradient(135deg,rgba(30,20,15,0.95),rgba(20,12,8,0.95));border:1px solid rgba(201,168,76,0.3);border-radius:6px;padding:clamp(1.25rem,4vw,2rem);max-width:420px;width:92%;max-height:calc(100dvh - 120px);overflow-y:auto;position:relative}
.love-letter::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--burgundy),var(--gold),var(--burgundy));border-radius:6px 6px 0 0}
.love-letter p{text-align:left;margin-bottom:0.85rem;font-size:clamp(0.95rem,2.6vw,1.05rem);line-height:1.75;color:var(--cream);opacity:0;transform:translateY(8px);transition:opacity 0.6s,transform 0.6s}
.love-letter p.visible{opacity:1;transform:translateY(0)}
.love-letter .signoff{font-style:italic;font-size:1.2rem;color:var(--gold);text-align:right;margin-top:1.5rem;opacity:0;transform:translateY(8px);transition:opacity 0.6s,transform 0.6s}
.love-letter .signoff.visible{opacity:1;transform:translateY(0)}

/* Hearts & confetti */
.hearts-container{position:fixed;inset:0;pointer-events:none;z-index:50;overflow:hidden}
.falling-heart{position:absolute;top:-30px;color:var(--burgundy-light);opacity:0;animation:fallH linear forwards}
@keyframes fallH{0%{opacity:0;transform:translateY(0) rotate(0deg)}10%{opacity:0.5}90%{opacity:0.3}100%{opacity:0;transform:translateY(100dvh) rotate(360deg)}}
.confetti-piece{position:absolute;top:-10px;opacity:0;animation:confF linear forwards}
@keyframes confF{0%{opacity:0;transform:translateY(0) rotate(0) scale(1)}10%{opacity:0.7}80%{opacity:0.5}100%{opacity:0;transform:translateY(100dvh) rotate(720deg) scale(0.5)}}

/* ===== SUCCESS MSG ===== */
.success-msg{font-family:Georgia,serif;font-size:clamp(1rem,2.8vw,1.15rem);color:var(--gold);text-align:center;margin-top:0.75rem;opacity:0;transition:opacity 0.5s}
.success-msg.visible{opacity:1}
.next-btn{background:rgba(201,168,76,0.12);border:1px solid var(--gold);color:var(--gold);padding:8px 24px;font-family:Georgia,serif;font-size:0.95rem;letter-spacing:0.05em;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:all 0.3s;border-radius:2px;margin-top:0.75rem;display:none}
.next-btn:active{background:rgba(201,168,76,0.25)}

/* ===== CAPTCHA OVERLAY ===== */
#captchaOverlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.92);display:flex;align-items:center;justify-content:center;padding:1rem}
.captcha-box{background:#f9f9f9;border-radius:8px;max-width:360px;width:100%;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,0.5)}
.captcha-header{background:#4a90d9;padding:16px 20px;color:#fff}
.captcha-header .captcha-label{font-family:Arial,Helvetica,sans-serif;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.08em;opacity:0.85;margin-bottom:4px}
.captcha-header h2{font-family:Arial,Helvetica,sans-serif;font-size:1.3rem;font-weight:400;line-height:1.3;margin:0}
.captcha-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;padding:3px;background:#f9f9f9}
.captcha-cell{position:relative;aspect-ratio:1;cursor:pointer;overflow:hidden;-webkit-tap-highlight-color:transparent}
.captcha-cell img{width:100%;height:100%;object-fit:cover;display:block;transition:transform 0.2s}
.captcha-cell.selected img{transform:scale(0.85)}
.captcha-cell::after{content:'';position:absolute;inset:0;border:4px solid transparent;transition:border-color 0.15s;pointer-events:none;border-radius:0}
.captcha-cell.selected::after{border-color:#4a90d9}
.captcha-check{position:absolute;bottom:4px;right:4px;width:24px;height:24px;background:#4a90d9;border-radius:50%;display:none;align-items:center;justify-content:center}
.captcha-cell.selected .captcha-check{display:flex}
.captcha-check svg{width:14px;height:14px}
.captcha-footer{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid #ddd}
.captcha-footer .recaptcha-brand{display:flex;align-items:center;gap:6px;font-family:Arial,sans-serif;font-size:0.65rem;color:#999}
.captcha-footer .recaptcha-brand .rc-logo{width:28px;height:28px;opacity:0.4}
.captcha-verify{background:#4a90d9;color:#fff;border:none;padding:8px 24px;border-radius:2px;font-family:Arial,sans-serif;font-size:0.85rem;font-weight:700;text-transform:uppercase;letter-spacing:0.03em;cursor:pointer;-webkit-tap-highlight-color:transparent;transition:background 0.2s}
.captcha-verify:hover{background:#3a7bc8}
.captcha-verify:active{background:#2d6ab5}
.captcha-error{font-family:Arial,sans-serif;font-size:0.8rem;color:#d93025;text-align:center;padding:8px;display:none}

/* ===== AUDIO MUTE BUTTON ===== */
.hud-btn.muted svg .sound-on{display:none}
.hud-btn.muted svg .sound-off{display:inline}
.hud-btn:not(.muted) svg .sound-off{display:none}
</style>
</head>
<body>
<!-- ========== CAPTCHA OVERLAY ========== -->
<div id="captchaOverlay">
  <div class="captcha-box">
    <div class="captcha-header">
      <div class="captcha-label">Select all images with</div>
      <h2>your Valentine</h2>
    </div>
    <div class="captcha-grid" id="captchaGrid"></div>
    <div class="captcha-error" id="captchaError">Please select all images of your Valentine.</div>
    <div class="captcha-footer">
      <div class="recaptcha-brand">
        <svg class="rc-logo" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="#aaa"/></svg>
        <div><strong>reCAPTCHA</strong><br>Privacy - Terms</div>
      </div>
      <button class="captcha-verify" onclick="verifyCaptcha()">VERIFY</button>
    </div>
  </div>
</div>

<div id="game">

<!-- ========== SCENE 1: DETECTIVE'S OFFICE ========== -->
<div id="scene1" class="scene active">
<div class="scene-bg"></div>
<div class="scene-content" style="justify-content:flex-end;padding-bottom:1rem">
  <button class="start-btn hotspot hotspot-pulse" id="beginBtn" onclick="beginCase()">Open Case File</button>
</div>
</div>

<!-- ========== SCENE 2: POTTERY STUDIO (TWO-PART PUZZLE) ========== -->
<div id="scene2" class="scene">
<div class="scene-bg"></div>
<div class="scene-content" style="justify-content:flex-end;padding-bottom:0.5rem">
  <div class="pottery-table" id="potteryTable">
    <div class="pottery-prompt" id="potteryPrompt"></div>
    <div class="pottery-grid" id="potteryGrid"></div>
    <div class="pottery-word" id="potteryWord"></div>
    <div class="letter-bank" id="letterBank"></div>
  </div>
  <div class="success-msg" id="potterySuccess"></div>
  <button class="next-btn" id="potteryNext" onclick="goToScene(3,'Traveling to London...')">Next Location &rarr;</button>
</div>
</div>

<!-- ========== SCENE 3: GYMKHANA LONDON (KARAOKE) ========== -->
<div id="scene3" class="scene">
<div class="scene-bg"></div>
<div class="scene-content" style="justify-content:center">
  <div class="karaoke-panel" id="karaokePanel">
    <h3>Karaoke Night</h3>
    <div class="karaoke-sub" id="karaokeSub"></div>
    <div id="songOptions"></div>
  </div>
  <div class="success-msg" id="karaokeSuccess"></div>
  <button class="next-btn" id="karaokeNext" onclick="goToScene(4,'Traveling to Thailand...')">Next Location &rarr;</button>
</div>
<div class="quip-toast" id="quipToast"></div>
</div>

<!-- ========== SCENE 4: KOH TAO UNDERWATER (5 HIDDEN OBJECTS) ========== -->
<div id="scene4" class="scene">
<div class="scene-bg"></div>
<div class="adventure-area" id="adventureScene" ontouchmove="handleSceneTouch(event)" onmousemove="handleSceneMouse(event)">
  <div class="found-counter" id="foundCounter">Evidence: 0 / 5</div>
  <!-- Hidden items positioned across the underwater scene -->
  <div class="hidden-item" id="item-cuttlefish" data-name="Cuttlefish" data-idx="0" style="top:25%;left:20%;" onclick="findItem(this)">
    <img src="assets/creature-cuttlefish.png" width="64" height="64" alt="Cuttlefish" style="border-radius:50%;object-fit:cover;">
  </div>
  <div class="hidden-item" id="item-manta-ray" data-name="Little Manta Ray" data-idx="1" style="top:15%;right:25%;" onclick="findItem(this)">
    <img src="assets/creature-manta-ray.png" width="64" height="64" alt="Manta Ray" style="border-radius:50%;object-fit:cover;">
  </div>
  <div class="hidden-item" id="item-trigger-fish" data-name="Trigger Fish" data-idx="2" style="top:55%;left:60%;" onclick="findItem(this)">
    <img src="assets/creature-trigger-fish.png" width="64" height="64" alt="Trigger Fish" style="border-radius:50%;object-fit:cover;">
  </div>
  <div class="hidden-item" id="item-big-tuna" data-name="Big Tuna" data-idx="3" style="top:40%;left:35%;" onclick="findItem(this)">
    <img src="assets/creature-big-tuna.png" width="64" height="64" alt="Big Tuna" style="border-radius:50%;object-fit:cover;">
  </div>
  <div class="hidden-item" id="item-sea-urchins" data-name="Sea Urchins" data-idx="4" style="bottom:15%;left:45%;" onclick="findItem(this)">
    <img src="assets/creature-sea-urchins.png" width="64" height="64" alt="Sea Urchins" style="border-radius:50%;object-fit:cover;">
  </div>
  <div class="magnify-circle" id="magnifyCircle"></div>
</div>
<div style="position:absolute;bottom:68px;left:0;right:0;z-index:10;text-align:center;padding:0 1rem">
  <div class="success-msg" id="adventureSuccess">All evidence collected. The dive log is complete.</div>
  <button class="next-btn" id="adventureNext" onclick="goToScene(5,'Heading to the amphitheater...')">Next Location &rarr;</button>
</div>
</div>

<!-- ========== SCENE 5: DILLON AMPHITHEATER (WORD PUZZLE, VW STYLE) ========== -->
<div id="scene5" class="scene">
<div class="scene-bg"></div>
<div class="scene-content" style="justify-content:center">
  <div class="stage-area">
    <div class="vw-header">Vampire Weekend &mdash; Dillon Amphitheater</div>
    <div class="word-slots" id="wordSlots"></div>
    <div class="word-bank" id="wordBank"></div>
  </div>
  <div class="success-msg" id="concertSuccess"></div>
  <button class="next-btn" id="concertNext" onclick="goToScene(6,'Solving the mystery...')">Solve the Mystery &rarr;</button>
</div>
</div>

<!-- ========== SCENE 6: VALENTINE'S ROOM ========== -->
<div id="scene6" class="scene">
<div class="scene-bg"></div>
<div class="scene-content" style="justify-content:center">
  <div class="love-letter" id="loveLetter"></div>
</div>
<div class="hearts-container" id="heartsContainer"></div>
</div>

<!-- ========== HUD BAR ========== -->
<div id="hud">
  <div class="hud-btn" onclick="toggleJournal()" title="Journal">
    <svg viewBox="0 0 24 24" fill="none" stroke="#c9a84c" stroke-width="1.5"><rect x="4" y="3" width="16" height="18" rx="2"/><line x1="8" y1="8" x2="16" y2="8"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="16" x2="12" y2="16"/></svg>
  </div>
  <div id="inventory">
    <!-- Slot 0: Coffee cup -->
    <div class="inv-slot" id="inv0"><svg viewBox="0 0 24 24" fill="none"><rect x="5" y="8" width="11" height="10" rx="2" stroke="#c9a84c" stroke-width="1.5"/><path d="M16,10 Q20,10 20,14 Q20,18 16,18" stroke="#c9a84c" stroke-width="1.5" fill="none"/><path d="M8,8 Q9,5 10,8" stroke="#c9a84c" stroke-width="1" opacity="0.5"/><path d="M11,7 Q12,4 13,7" stroke="#c9a84c" stroke-width="1" opacity="0.5"/></svg></div>
    <!-- Slot 1: Microphone -->
    <div class="inv-slot" id="inv1"><svg viewBox="0 0 24 24" fill="none"><rect x="9" y="4" width="6" height="10" rx="3" stroke="#c9a84c" stroke-width="1.5"/><path d="M6,12 Q6,17 12,17 Q18,17 18,12" stroke="#c9a84c" stroke-width="1.5" fill="none"/><line x1="12" y1="17" x2="12" y2="21" stroke="#c9a84c" stroke-width="1.5"/><line x1="8" y1="21" x2="16" y2="21" stroke="#c9a84c" stroke-width="1.5"/></svg></div>
    <!-- Slot 2: Diving mask -->
    <div class="inv-slot" id="inv2"><svg viewBox="0 0 24 24" fill="none"><rect x="3" y="8" width="18" height="9" rx="4" stroke="#c9a84c" stroke-width="1.5"/><circle cx="9" cy="12" r="3.5" stroke="#c9a84c" stroke-width="1"/><circle cx="15" cy="12" r="3.5" stroke="#c9a84c" stroke-width="1"/><line x1="12" y1="10" x2="12" y2="14" stroke="#c9a84c" stroke-width="1"/><path d="M3,11 L1,9" stroke="#c9a84c" stroke-width="1.5"/></svg></div>
    <!-- Slot 3: Music note -->
    <div class="inv-slot" id="inv3"><svg viewBox="0 0 24 24" fill="none"><circle cx="8" cy="18" r="3" fill="#c9a84c"/><line x1="11" y1="18" x2="11" y2="5" stroke="#c9a84c" stroke-width="1.5"/><path d="M11,5 Q16,3 18,7" stroke="#c9a84c" stroke-width="1.5" fill="none"/></svg></div>
  </div>
  <div class="hud-btn" id="muteBtn" onclick="toggleMute()" title="Toggle Audio">
    <svg viewBox="0 0 24 24" fill="none" stroke="#c9a84c" stroke-width="1.5">
      <g class="sound-on"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07" stroke-linecap="round"/><path d="M19.07 4.93a10 10 0 010 14.14" stroke-linecap="round"/></g>
      <g class="sound-off"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15" stroke-linecap="round"/><line x1="17" y1="9" x2="23" y2="15" stroke-linecap="round"/></g>
    </svg>
  </div>
  <div class="hud-btn" onclick="togglePhone()" title="Phone">
    <svg viewBox="0 0 24 24" fill="none" stroke="#c9a84c" stroke-width="1.5"><rect x="6" y="3" width="12" height="18" rx="2"/><line x1="10" y1="18" x2="14" y2="18"/></svg>
  </div>
</div>

<!-- ========== DIALOG BOX ========== -->
<div id="dialogOverlay">
  <div id="dialogBox" onclick="advanceDialog()">
    <div id="dialogIcon"><svg viewBox="0 0 24 24" fill="none" stroke="#c9a84c" stroke-width="1.5"><circle cx="11" cy="11" r="6"/><line x1="15.5" y1="15.5" x2="20" y2="20" stroke-linecap="round"/></svg></div>
    <div id="dialogText"></div>
    <div class="dialog-continue">tap to continue</div>
  </div>
</div>

<!-- ========== TRANSITION OVERLAY ========== -->
<div id="transitionOverlay"><div id="transitionText"></div></div>

<!-- ========== JOURNAL POPUP ========== -->
<div id="journalPopup" onclick="if(event.target===this)toggleJournal()">
  <div class="journal-content">
    <h3>Case Notes</h3>
    <div id="journalEntries"></div>
    <button class="journal-close" onclick="toggleJournal()">Close</button>
  </div>
</div>

<!-- ========== PHONE POPUP ========== -->
<div id="phonePopup" onclick="if(event.target===this)togglePhone()">
  <div class="phone-content">
    <div class="notif">1 new message</div>
    <div class="msg" id="phoneSender" style="color:var(--gold);font-weight:700">Sam</div>
    <div class="msg" id="phoneMsg" style="font-size:0.9rem;opacity:0.7"></div>
    <button class="phone-close" onclick="togglePhone()">Close</button>
  </div>
</div>

<!-- ========== MEMORY NOTE POPUP ========== -->
<div id="memoryPopup" onclick="if(event.target===this)dismissMemory()">
  <div class="memory-content">
    <div class="memory-vignette" id="memoryVignette"></div>
    <div class="memory-text-area">
      <div class="memory-title" id="memoryTitle"></div>
      <div class="memory-body" id="memoryBody"></div>
      <button class="memory-dismiss" onclick="dismissMemory()">Continue</button>
    </div>
  </div>
</div>

</div>

<script>
// ==================== AUDIO MANAGER ====================
const AudioManager = {
  music: new Audio(),
  narrator: new Audio(),
  sfxPool: Array.from({length:4}, () => new Audio()),
  sfxIndex: 0,
  volume: { master: 1, music: 0.3, sfx: 0.5, narrator: 0.8 },
  muted: localStorage.getItem('nd-muted') === 'true',
  currentMusicSrc: '',
  narratorPlaying: false,

  init() {
    this.music.loop = true;
    if (this.muted) {
      document.getElementById('muteBtn').classList.add('muted');
    }
    // Preload SFX on first user interaction
    const preload = () => {
      this.preloadSFX();
      document.removeEventListener('click', preload);
      document.removeEventListener('touchend', preload);
    };
    document.addEventListener('click', preload);
    document.addEventListener('touchend', preload);
  },

  _vol(type) {
    if (this.muted) return 0;
    return this.volume.master * this.volume[type];
  },

  // ── Music ──
  playMusic(scene) {
    const src = 'assets/audio/music-scene' + scene + '.mp3';
    if (this.currentMusicSrc === src) return;
    this.currentMusicSrc = src;
    // Crossfade
    const oldVol = this.music.volume;
    const fadeOut = () => {
      if (this.music.volume > 0.02) {
        this.music.volume = Math.max(0, this.music.volume - 0.05);
        requestAnimationFrame(fadeOut);
      } else {
        this.music.src = src;
        this.music.volume = 0;
        this.music.play().catch(() => {});
        this._fadeInMusic();
      }
    };
    if (this.music.src && !this.music.paused) {
      fadeOut();
    } else {
      this.music.src = src;
      this.music.volume = 0;
      this.music.play().catch(() => {});
      this._fadeInMusic();
    }
  },

  _fadeInMusic() {
    const target = this._vol('music');
    const step = () => {
      if (this.music.volume < target - 0.02) {
        this.music.volume = Math.min(target, this.music.volume + 0.03);
        requestAnimationFrame(step);
      } else {
        this.music.volume = target;
      }
    };
    step();
  },

  // ── Narrator ──
  playNarrator(file, onEnd) {
    this.narrator.src = 'assets/audio/' + file;
    this.narrator.volume = this._vol('narrator');
    this.narratorPlaying = true;
    this.narrator.onended = () => {
      this.narratorPlaying = false;
      if (onEnd) onEnd();
    };
    this.narrator.onerror = () => {
      this.narratorPlaying = false;
      if (onEnd) onEnd();
    };
    this.narrator.play().catch(() => {
      this.narratorPlaying = false;
      if (onEnd) onEnd();
    });
  },

  stopNarrator() {
    if (this.narratorPlaying) {
      this.narrator.pause();
      this.narrator.currentTime = 0;
      this.narratorPlaying = false;
      this.narrator.onended = null;
    }
  },

  // ── SFX ──
  playSFX(file) {
    const audio = this.sfxPool[this.sfxIndex % this.sfxPool.length];
    this.sfxIndex++;
    audio.src = 'assets/audio/' + file;
    audio.volume = this._vol('sfx');
    audio.play().catch(() => {});
  },

  preloadSFX() {
    const files = [
      'sfx-letter-place.mp3','sfx-letter-wrong.mp3','sfx-puzzle-complete.mp3',
      'sfx-transition.mp3','sfx-item-found.mp3','sfx-inventory.mp3',
      'sfx-dialog-advance.mp3','sfx-song-correct.mp3','sfx-song-wrong.mp3',
      'sfx-word-place.mp3','sfx-word-remove.mp3','sfx-hearts.mp3'
    ];
    files.forEach(f => {
      const a = new Audio();
      a.preload = 'auto';
      a.src = 'assets/audio/' + f;
    });
  },

  // ── Preload scene audio ──
  preloadScene(scene) {
    // Preload next scene's music
    const musicPreload = new Audio();
    musicPreload.preload = 'auto';
    musicPreload.src = 'assets/audio/music-scene' + scene + '.mp3';
  },

  // ── Mute ──
  toggleMute() {
    this.muted = !this.muted;
    localStorage.setItem('nd-muted', this.muted);
    document.getElementById('muteBtn').classList.toggle('muted', this.muted);
    this.music.volume = this._vol('music');
    this.narrator.volume = this._vol('narrator');
  }
};

// ── Narrator audio file mapping ──
const NARRATOR_MAP = {
  // scene1 dialog
  's1-0':'s1-d0.mp3','s1-1':'s1-d1.mp3','s1-2':'s1-d2.mp3',
  's1-3':'s1-d3.mp3','s1-4':'s1-d4.mp3','s1-5':'s1-d5.mp3',
  // scene2 dialog
  's2-0':'s2-d0.mp3','s2-1':'s2-d1.mp3','s2-2':'s2-d2.mp3','s2-3':'s2-d3.mp3',
  's2-success-0':'s2-success.mp3',
  // scene3 dialog
  's3-0':'s3-d0.mp3','s3-1':'s3-d1.mp3','s3-2':'s3-d2.mp3','s3-3':'s3-d3.mp3',
  's3-success-0':'s3-success.mp3',
  // scene4 dialog
  's4-0':'s4-d0.mp3','s4-1':'s4-d1.mp3','s4-2':'s4-d2.mp3','s4-3':'s4-d3.mp3',
  's4-success-0':'s4-success.mp3',
  's4-found-0':'s4-found0.mp3','s4-found-1':'s4-found1.mp3','s4-found-2':'s4-found2.mp3',
  's4-found-3':'s4-found3.mp3','s4-found-4':'s4-found4.mp3',
  // scene5 dialog
  's5-0':'s5-d0.mp3','s5-1':'s5-d1.mp3','s5-2':'s5-d2.mp3','s5-3':'s5-d3.mp3',
  's5-success-0':'s5-success0.mp3','s5-success-1':'s5-success1.mp3'
};

function toggleMute() { AudioManager.toggleMute(); }

// ==================== CONTENT DATA ====================
const CONTENT = {
  scene1: {
    dialog: [
      {speaker:"narrator",text:"A new case file lands on your desk. The label reads: VALENTINE'S DAY - CLASSIFIED."},
      {speaker:"narrator",text:"You open it. Inside, a note:"},
      {speaker:"casefile",text:"Carter, something's been stolen. Five of our best memories have gone missing, scattered across the places that matter most to us. I need you to find them. Follow the clues. Trust your instincts. I know how much you love a good puzzle."},
      {speaker:"casefile",text:"-- Sam"},
      {speaker:"narrator",text:"Pinned to the note: a photo of a pottery studio, a plane ticket stub, a dive log, a concert wristband, and a faded Polaroid of mountains at sunset."},
      {speaker:"narrator",text:"Your journal is open. Your phone is charged. Let's get to work, detective."}
    ]
  },
  scene2: {
    dialog: [
      {speaker:"narrator",text:"The first clue leads to a pottery studio in Denver. CITY MUD. The air smells like wet clay and coffee grounds."},
      {speaker:"narrator",text:"Someone left a half-finished mug on the wheel. There's a note tucked inside it."},
      {speaker:"note",text:"This is where it started. I saw you across the studio in overalls, hands covered in slip, and thought: okay, she's trouble. I like trouble. I needed an excuse to talk to you outside of the studio. So I came up with one."},
      {speaker:"narrator",text:"Two puzzles guard the memory hidden here. Crack them both."}
    ],
    puzzle_part1_prompt:"What drink did Sam use as an excuse to keep hanging out after class?",
    puzzle_part1_answer:"ICEDCOFFEE",
    puzzle_part1_display:"ICED COFFEE",
    puzzle_part2_prompt:"What was our first activity outside the studio?",
    puzzle_part2_answer:"SLOOP",
    puzzle_part2_display:"SLOOP",
    success_dialog:[{speaker:"narrator",text:"The locks click open. A memory surfaces, warm and specific, like clay still holding the shape of someone's hands."}],
    memory_note:{
      title:"Sam's Memory: City Mud",
      text:"Remember our first classes together, making eye contact and me trying to time my kneading so that we could have an excuse to talk. Hearing about how you were coming from DC and learning more about you. Thinking about how cute you looked in your overalls and how good your butt looked. Scrolling Instagram on City of Mud and seeing them post something of yours and tag you. Sliding into the DMs and getting to know you. Quiet times at the studio, listening to music, talking about our families, our past. Getting iced coffee and going to Sloop and that's where you first told me about how bad you wanted to go to Asia."
    },
    phone_message:"Hope you're having fun playing detective. This first one's easy. It only gets harder from here cc"
  },
  scene3: {
    dialog: [
      {speaker:"narrator",text:"The next clue takes you across the Atlantic. London. A football stadium, an incredible restaurant, and a club with a stage."},
      {speaker:"narrator",text:"On the table at Gymkhana, someone's left a menu with a question circled in pen."},
      {speaker:"note",text:"London was a gamble. Early days. Lots of time together with nowhere to hide. But we crushed it. We traveled well together. We ate incredible food. I watched the Pats lose and I didn't care because I saw how happy you were."},
      {speaker:"narrator",text:"We drank and danced and bar hopped till we found our way to a club and made our debut on the London stage."}
    ],
    puzzle_prompt:"What song did you two absolutely destroy at karaoke that night?",
    options: [
      {song:"Mr. Brightside - The Killers",correct:true,quip:null},
      {song:"Don't Stop Believin' - Journey",correct:false,quip:"Classic, but no. We have more edge than that. Barely. But still."},
      {song:"Livin' on a Prayer - Bon Jovi",correct:false,quip:"I mean, we probably did this one too. But it's not THE one."},
      {song:"Sweet Caroline - Neil Diamond",correct:false,quip:"Babe. I'm from Boston. I've been permanently banned from singing this in public."}
    ],
    success_dialog:[{speaker:"narrator",text:"The opening synth hits and the memory comes flooding back. Two people, deliriously tired, screaming into microphones like their lives depended on it."}],
    memory_note:{
      title:"Sam's Memory: London",
      text:"London was a big swing. We were still pretty new. It was built around the Patriots and the Jaguars playing each other in London, and it was just spur of the moment. I said we should go. You said yeah. And with that, we ended up doing about a week in London. The food at Gymkhana was insane. We bar hopped and danced and sang until we were exhausted and I was losing my voice. And I remember thinking how I'd never had so much fun traveling one-on-one with someone before."
    },
    phone_message:"Fun fact I still can't hear Mr. Brightside without thinking of you trying to hit that high note. Iconic honestly"
  },
  scene4: {
    dialog: [
      {speaker:"narrator",text:"The trail leads to Thailand. Koh Tao. Warm water. Sunlight cutting through the surface in shafts."},
      {speaker:"narrator",text:"A dive log is open on the boat. The entry reads:"},
      {speaker:"note",text:"It was like another planet down there, and exploring it with you is like a dream come true."},
      {speaker:"narrator",text:"The reef is alive with creatures. Find all five things Sam remembers from the dive."}
    ],
    hidden_objects: [
      {id:"cuttlefish",name:"Cuttlefish",found_text:"I think this is my favorite fish. It felt so alien and so much like a UFO, and it was so cool to see Toni excited about it."},
      {id:"manta-ray",name:"Little Manta Ray",found_text:"Little manta ray, it was just hiding in a cave."},
      {id:"trigger-fish",name:"Trigger Fish",found_text:"This one looked personally offended that we were in its neighborhood. Gave us the dirtiest look a fish can give."},
      {id:"big-tuna",name:"Big Tuna",found_text:"Absolutely massive. After finding out how much it's worth, we definitely should have tried to steal it."},
      {id:"sea-urchins",name:"Sea Urchins",found_text:"Remember seeing them move? Remember seeing Toni pick one up with his hands?"}
    ],
    success_dialog:[{speaker:"narrator",text:"All five found. The dive log entry completes itself, ink spreading across the page like watercolor."}],
    memory_note:{
      title:"Sam's Memory: Koh Tao",
      text:"Diving with you was surreal. All of the different fish, the coral — and even though we didn't get to see a whale shark this time, I'm so excited we got to add another hobby to our quiver for future adventures and for making new friends. I just remember thinking about how pretty fucking cool you are and how fun life is with you."
    },
    phone_message:"They swam right over us remember?? Still think about that cuttlefish honestly. He was just vibing"
  },
  scene5: {
    dialog: [
      {speaker:"narrator",text:"The final clue brings you home. Colorado. Dillon Amphitheater. The sun is going down behind the mountains and the lake is catching the last of the light."},
      {speaker:"narrator",text:"Vampire Weekend is playing. The air is warm and the crowd is swaying and someone left a note folded under your seat."},
      {speaker:"note",text:"This is the night I knew. Not 'liked you' knew. Really knew. The sun was doing that thing behind the mountains and you were standing there and I just thought: yeah. This one's different."},
      {speaker:"narrator",text:"Carter baked Sam something special for his birthdays. What were they? Put the words together."}
    ],
    target_phrase:["brownies","and","carrot","cake"],
    extra_words:["cookies","pie","muffins","bread"],
    success_dialog:[
      {speaker:"narrator",text:"The answer clicks into place. Brownies and carrot cake. Two birthdays, two batches of love — one of them ding-dong ditched."},
      {speaker:"narrator",text:"\"Brownies and carrot cake.\""}
    ],
    memory_note:{
      title:"Sam's Memory: Dillon",
      text:"The sun was setting behind the mountains and the lake was right there and Vampire Weekend was playing and you were standing next to me and I just had this moment. This really clear, calm moment where I thought: I really, really like this person. Not in the butterflies way. In the quiet, sure way. And then you baked me brownies and ding-dong ditched them at my door. And then carrot cake for the next one. That's the kind of love that doesn't need to announce itself."
    },
    phone_message:"Almost there detective. One more stop. You're gonna want to sit down for this one"
  },
  scene6: {
    love_letter_paragraphs: [
      "Carter,",
      "I've been trying to figure out how to say this and I keep overcomplicating it. So I'm just going to talk.",
      "You walked into a pottery studio and I slid into your DMs. First time I've ever done that with anyone. And honestly, it's the best decision I've ever made. Including going to Colby. Including any job I've ever taken. Getting iced coffee with you and walking around at Sloop — those are the best decisions I've ever made.",
      "And then we made London happen on a whim. I love that — so fun, so spontaneous. We ate at Gymkhana, screamed Mr. Brightside, scared some Brits, saw a fat beast. I even had to watch the Pats lose, and it hurt. But I didn't really care. I didn't care because I was with you and I could see how happy you were. That's real love, Carter.",
      "And of course there was Thailand, there was Taiwan, there's diving, the elephant sanctuary. There was Dillon and Vampire Weekend. Kayaking in Vinalhaven. Our trip to Arizona. These are some of my favorite memories of our time together so far, and even then it's just a tiny slice of all the time I've enjoyed spending with you.",
      "Ice skating. Museums in London. Vinalhaven trips. Christmas in Arizona. The DC Marathon. All of our training days together. Our sweaty, sweaty yoga sessions — when you mostly figured out that spinning move from gymnastics and I convinced myself I could do it too. Helping you move and paint your house. Your hibachi party. Playing tennis together. Watching Inside Out 2. Watching Nosferatu. Skiing together.",
      "The list goes on and on. It really does. And it doesn't even begin to scratch the surface of how much more I want to do with you.",
      "I hope you know how much I love you. And even if you say you know, I'm going to keep reminding you. Because you mean so much to me. You're so important to me. And I just appreciate you so much.",
      "Happy Valentine's Day, cc."
    ],
    signoff:"xo, Sam",
    phone_message:"I love you tons. Happy Valentine's Day babe"
  },
  journal_notes: [
    {label:"City Mud Studio",hint:"Two puzzles to solve. How far back can you remember?",solved:"Unlocked: Iced coffee was just an excuse. Sloop was just the beginning."},
    {label:"Gymkhana London",hint:"Name the song that brought the house down.",solved:"Unlocked: Mr. Brightside, screamed until deliriously exhausted."},
    {label:"Koh Tao Dive",hint:"Five creatures hide in the reef.",solved:"Unlocked: Another planet, except she was there too."},
    {label:"Dillon Amphitheater",hint:"What did Carter bake for Sam's birthdays?",solved:"Unlocked: Brownies and carrot cake. Ding-dong ditched with love."}
  ]
};

// ==================== STATE ====================
let currentScene = 1;
const totalScenes = 6;
let dialogQueue = [];
let dialogCallback = null;
const cluesSolved = [false,false,false,false]; // pottery, gymkhana, underwater, dillon
let memoryCallback = null;

// ==================== DIALOG SYSTEM ====================
let dialogAudioTag = '';  // e.g. 's1' for scene1 dialog, 's2-success' etc.
let dialogLineIndex = 0;

function showDialog(lines, cb, audioTag) {
  dialogQueue = Array.isArray(lines) ? [...lines] : [lines];
  dialogCallback = cb || null;
  dialogAudioTag = audioTag || '';
  dialogLineIndex = 0;
  showNextLine();
}
function showNextLine() {
  if (!dialogQueue.length) {
    document.getElementById('dialogBox').classList.remove('show');
    AudioManager.stopNarrator();
    if (dialogCallback) { const cb = dialogCallback; dialogCallback = null; cb(); }
    return;
  }
  const line = dialogQueue.shift();
  const box = document.getElementById('dialogBox');
  const text = document.getElementById('dialogText');
  if (typeof line === 'object') {
    text.innerHTML = '<span class="speaker">' + line.speaker + '</span>' + line.text;
  } else {
    text.innerHTML = line;
  }
  box.classList.add('show');

  // Play narrator audio if mapped
  const audioKey = dialogAudioTag + '-' + dialogLineIndex;
  const audioFile = NARRATOR_MAP[audioKey];
  dialogLineIndex++;
  if (audioFile && typeof line === 'object' && ['narrator','note','casefile'].includes(line.speaker)) {
    AudioManager.playNarrator(audioFile, () => {
      // Auto-advance on narration end
      if (dialogQueue.length > 0) showNextLine();
      else advanceDialog();
    });
  }
  AudioManager.playSFX('sfx-dialog-advance.mp3');
}
function advanceDialog() {
  AudioManager.stopNarrator();
  showNextLine();
}

// ==================== SCENE MANAGEMENT ====================
function goToScene(n, transText) {
  AudioManager.playSFX('sfx-transition.mp3');
  const overlay = document.getElementById('transitionOverlay');
  const tText = document.getElementById('transitionText');
  tText.textContent = transText || 'Loading...';
  overlay.classList.add('show');
  setTimeout(() => {
    document.getElementById('scene' + currentScene).classList.remove('active');
    document.getElementById('scene' + n).classList.add('active');
    currentScene = n;
    AudioManager.playMusic(n);
    // Preload next scene
    if (n < totalScenes) AudioManager.preloadScene(n + 1);
    setTimeout(() => {
      overlay.classList.remove('show');
      if (n === 2) initPottery();
      if (n === 3) initKaraoke();
      if (n === 4) initAdventure();
      if (n === 5) initConcert();
      if (n === 6) initLoveLetter();
    }, 400);
  }, 800);
}

function beginCase() {
  AudioManager.preloadScene(2);
  showDialog(CONTENT.scene1.dialog, () => {
    goToScene(2, 'Traveling to the pottery studio...');
  }, 's1');
}

// ==================== INVENTORY ====================
function addInventoryItem(index) {
  cluesSolved[index] = true;
  document.getElementById('inv' + index).classList.add('filled');
  AudioManager.playSFX('sfx-inventory.mp3');
}

// ==================== JOURNAL ====================
function toggleJournal() {
  const popup = document.getElementById('journalPopup');
  popup.classList.toggle('show');
  if (popup.classList.contains('show')) {
    const entries = document.getElementById('journalEntries');
    entries.innerHTML = '';
    CONTENT.journal_notes.forEach((n, i) => {
      const div = document.createElement('div');
      div.className = 'journal-entry' + (cluesSolved[i] ? '' : ' unsolved');
      div.innerHTML = '<strong>' + n.label + '</strong><br>' + (cluesSolved[i] ? n.solved : n.hint);
      entries.appendChild(div);
    });
  }
}

// ==================== PHONE (CONTEXT-SENSITIVE) ====================
function togglePhone() {
  const popup = document.getElementById('phonePopup');
  popup.classList.toggle('show');
  if (popup.classList.contains('show')) {
    updatePhoneMessage();
  }
}
function updatePhoneMessage() {
  const sceneKey = 'scene' + currentScene;
  const data = CONTENT[sceneKey];
  const msgEl = document.getElementById('phoneMsg');
  if (data && data.phone_message) {
    msgEl.textContent = '"' + data.phone_message + '"';
  } else {
    msgEl.textContent = '"Hey detective, how\'s the case going? Miss you."';
  }
}

// ==================== MEMORY NOTE POPUP ====================
const MEMORY_IMAGES = {
  2: 'assets/memory-pottery.jpg',
  3: 'assets/memory-london.jpg',
  4: 'assets/memory-underwater.jpg',
  5: 'assets/memory-dillon.jpg'
};

function showMemoryNote(memoryData, sceneNum, cb) {
  const popup = document.getElementById('memoryPopup');
  const title = document.getElementById('memoryTitle');
  const body = document.getElementById('memoryBody');
  const vignette = document.getElementById('memoryVignette');

  title.textContent = memoryData.title;
  body.textContent = memoryData.text;

  // Try loading vignette image
  const imgPath = MEMORY_IMAGES[sceneNum] || '';
  const testImg = new Image();
  testImg.onload = function() {
    vignette.style.backgroundImage = 'url(' + imgPath + ')';
    vignette.classList.add('has-image');
  };
  testImg.onerror = function() {
    vignette.classList.remove('has-image');
    vignette.style.backgroundImage = '';
  };
  testImg.src = imgPath;

  memoryCallback = cb || null;
  popup.classList.add('show');
}
function dismissMemory() {
  const popup = document.getElementById('memoryPopup');
  popup.classList.remove('show');
  if (memoryCallback) { const cb = memoryCallback; memoryCallback = null; cb(); }
}

// ==================== SCENE 2: POTTERY (TWO-PART PUZZLE) ====================
let potteryPart = 1;
let potteryIndex = 0;
let potteryInited = false;
let currentPotteryAnswer = '';

function initPottery() {
  if (potteryInited) return;
  potteryInited = true;
  showDialog(CONTENT.scene2.dialog, () => {
    setupPotteryPart(1);
  }, 's2');
}

function setupPotteryPart(part) {
  potteryPart = part;
  potteryIndex = 0;
  const prompt = document.getElementById('potteryPrompt');
  const grid = document.getElementById('potteryGrid');
  const bank = document.getElementById('letterBank');
  const word = document.getElementById('potteryWord');
  grid.innerHTML = '';
  bank.innerHTML = '';
  word.textContent = '';

  if (part === 1) {
    currentPotteryAnswer = CONTENT.scene2.puzzle_part1_answer;
    prompt.textContent = CONTENT.scene2.puzzle_part1_prompt;
    const decoys = ['F','H','D','A','P','W'];
    const answerLetters = currentPotteryAnswer.split('');
    for (let i = 0; i < answerLetters.length; i++) {
      const shard = document.createElement('div');
      shard.className = 'shard empty';
      shard.id = 'slot-' + i;
      grid.appendChild(shard);
    }
    const allLetters = [...answerLetters, ...decoys];
    shuffle(allLetters);
    allLetters.forEach(letter => {
      const tile = document.createElement('div');
      tile.className = 'letter-tile';
      tile.textContent = letter;
      tile.onclick = () => pickLetter(tile, letter);
      bank.appendChild(tile);
    });
  } else {
    currentPotteryAnswer = CONTENT.scene2.puzzle_part2_answer;
    prompt.textContent = CONTENT.scene2.puzzle_part2_prompt;
    const decoys = ['A','T','W','R'];
    const answerLetters = currentPotteryAnswer.split('');
    for (let i = 0; i < answerLetters.length; i++) {
      const shard = document.createElement('div');
      shard.className = 'shard empty';
      shard.id = 'slot-' + i;
      grid.appendChild(shard);
    }
    const allLetters = [...answerLetters, ...decoys];
    shuffle(allLetters);
    allLetters.forEach(letter => {
      const tile = document.createElement('div');
      tile.className = 'letter-tile';
      tile.textContent = letter;
      tile.onclick = () => pickLetter(tile, letter);
      bank.appendChild(tile);
    });
  }
}

function pickLetter(tile, letter) {
  if (tile.classList.contains('used') || potteryIndex >= currentPotteryAnswer.length) return;
  if (letter === currentPotteryAnswer[potteryIndex]) {
    AudioManager.playSFX('sfx-letter-place.mp3');
    tile.classList.add('used');
    const slot = document.getElementById('slot-' + potteryIndex);
    slot.textContent = letter;
    slot.classList.remove('empty');
    slot.classList.add('placed');
    potteryIndex++;

    // Update display word
    const display = potteryPart === 1 ? CONTENT.scene2.puzzle_part1_display : CONTENT.scene2.puzzle_part2_display;
    const progress = display.substring(0, potteryIndex + (potteryPart === 1 ? (potteryIndex >= 4 ? 1 : 0) : 0));
    document.getElementById('potteryWord').textContent = currentPotteryAnswer.substring(0, potteryIndex);

    if (potteryIndex === currentPotteryAnswer.length) {
      AudioManager.playSFX('sfx-puzzle-complete.mp3');
      // Show the display version
      document.getElementById('potteryWord').textContent = potteryPart === 1 ? CONTENT.scene2.puzzle_part1_display : CONTENT.scene2.puzzle_part2_display;

      if (potteryPart === 1) {
        setTimeout(() => {
          showDialog([{speaker:'Lock 1', text:'Unlocked: ' + CONTENT.scene2.puzzle_part1_display + '. One more lock to go.'}], () => {
            setupPotteryPart(2);
          });
        }, 400);
      } else {
        setTimeout(() => {
          showDialog(CONTENT.scene2.success_dialog, () => {
            addInventoryItem(0);
            showMemoryNote(CONTENT.scene2.memory_note, 2, () => {
              document.getElementById('potterySuccess').textContent = 'Memory recovered. The investigation continues.';
              document.getElementById('potterySuccess').classList.add('visible');
              document.getElementById('potteryNext').style.display = 'inline-block';
            });
          }, 's2-success');
        }, 400);
      }
    }
  } else {
    AudioManager.playSFX('sfx-letter-wrong.mp3');
    tile.style.transform = 'translateX(-4px)';
    setTimeout(() => tile.style.transform = 'translateX(4px)', 80);
    setTimeout(() => tile.style.transform = '', 160);
  }
}

// ==================== SCENE 3: GYMKHANA KARAOKE ====================
let karaokeInited = false;
let karaokeSolved = false;

function initKaraoke() {
  if (karaokeInited) return;
  karaokeInited = true;
  const karaokeSetup = () => {
    const sub = document.getElementById('karaokeSub');
    sub.textContent = CONTENT.scene3.puzzle_prompt;
    const container = document.getElementById('songOptions');
    container.innerHTML = '';
    const options = [...CONTENT.scene3.options];
    shuffle(options);
    options.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = 'song-option';
      btn.textContent = opt.song;
      btn.onclick = () => pickSong(btn, opt);
      container.appendChild(btn);
    });
  };
  showDialog(CONTENT.scene3.dialog, karaokeSetup, 's3');
}

function pickSong(btn, opt) {
  if (karaokeSolved) return;
  if (opt.correct) {
    AudioManager.playSFX('sfx-song-correct.mp3');
    karaokeSolved = true;
    btn.classList.add('correct-answer');
    document.querySelectorAll('.song-option').forEach(b => { if (b !== btn) b.style.opacity = '0.3'; });
    setTimeout(() => {
      showDialog(CONTENT.scene3.success_dialog, () => {
        addInventoryItem(1);
        showMemoryNote(CONTENT.scene3.memory_note, 3, () => {
          document.getElementById('karaokeSuccess').textContent = 'Memory recovered. The trail leads east.';
          document.getElementById('karaokeSuccess').classList.add('visible');
          document.getElementById('karaokeNext').style.display = 'inline-block';
        });
      }, 's3-success');
    }, 500);
  } else {
    AudioManager.playSFX('sfx-song-wrong.mp3');
    btn.classList.add('wrong-answer');
    setTimeout(() => btn.classList.remove('wrong-answer'), 800);
    const toast = document.getElementById('quipToast');
    toast.textContent = opt.quip;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
  }
}

// ==================== SCENE 4: KOH TAO UNDERWATER ====================
let foundItems = 0;
const totalItems = 5;
let adventureInited = false;

function initAdventure() {
  if (adventureInited) return;
  adventureInited = true;
  showDialog(CONTENT.scene4.dialog, null, 's4');
}

function handleSceneMouse(e) {
  const rect = e.currentTarget.getBoundingClientRect();
  updateMagnifier(e.currentTarget, e.clientX - rect.left, e.clientY - rect.top);
  checkProximity(e.currentTarget, e.clientX - rect.left, e.clientY - rect.top);
}
function handleSceneTouch(e) {
  e.preventDefault();
  const rect = e.currentTarget.getBoundingClientRect();
  const t = e.touches[0];
  updateMagnifier(e.currentTarget, t.clientX - rect.left, t.clientY - rect.top);
  checkProximity(e.currentTarget, t.clientX - rect.left, t.clientY - rect.top);
}
function updateMagnifier(c, x, y) {
  const circle = document.getElementById('magnifyCircle');
  circle.style.left = (x - 40) + 'px';
  circle.style.top = (y - 40) + 'px';
  circle.style.opacity = '1';
}
function checkProximity(container, x, y) {
  let anyNear = false;
  container.querySelectorAll('.hidden-item:not(.found)').forEach(item => {
    const ix = item.offsetLeft + item.offsetWidth / 2;
    const iy = item.offsetTop + item.offsetHeight / 2;
    const dist = Math.sqrt((x - ix) ** 2 + (y - iy) ** 2);
    const isNear = dist < 100;
    item.classList.toggle('near', isNear);
    if (isNear) anyNear = true;
  });
  document.getElementById('magnifyCircle').classList.toggle('near-item', anyNear);
}
function findItem(el) {
  const idx = parseInt(el.dataset.idx);
  const objData = CONTENT.scene4.hidden_objects[idx];
  if (el.classList.contains('found')) {
    showDialog([{speaker:'Evidence Found', text:objData.name + ' - ' + objData.found_text}], null, 's4-found');
    dialogAudioTag = 's4-found'; dialogLineIndex = idx;
    return;
  }
  AudioManager.playSFX('sfx-item-found.mp3');
  el.classList.remove('near');
  el.classList.add('found');
  foundItems++;
  document.getElementById('foundCounter').textContent = 'Evidence: ' + foundItems + ' / ' + totalItems;

  // Play found_text narrator audio
  const foundAudioFile = NARRATOR_MAP['s4-found-' + idx];
  if (foundAudioFile) AudioManager.playNarrator(foundAudioFile);

  if (foundItems === totalItems) {
    showDialog([{speaker:'Evidence Found', text:objData.name + ' - ' + objData.found_text}], () => {
      showDialog(CONTENT.scene4.success_dialog, () => {
        addInventoryItem(2);
        showMemoryNote(CONTENT.scene4.memory_note, 4, () => {
          document.getElementById('adventureSuccess').classList.add('visible');
          document.getElementById('adventureNext').style.display = 'inline-block';
        });
      }, 's4-success');
    });
  } else {
    showDialog([{speaker:'Evidence Found', text:objData.name + ' - ' + objData.found_text}]);
  }
}

// ==================== SCENE 5: DILLON CONCERT ====================
const TARGET_PHRASE = CONTENT.scene5.target_phrase;
let placedWords = [];
let concertInited = false;

function initConcert() {
  if (concertInited) return;
  concertInited = true;
  const concertSetup = () => {
    const bank = document.getElementById('wordBank');
    const allWords = [...TARGET_PHRASE, ...CONTENT.scene5.extra_words];
    shuffle(allWords);
    allWords.forEach(word => {
      const tile = document.createElement('div');
      tile.className = 'word-tile';
      tile.textContent = word;
      tile.onclick = () => addWord(tile, word);
      bank.appendChild(tile);
    });
  };
  showDialog(CONTENT.scene5.dialog, concertSetup, 's5');
}

function addWord(tile, word) {
  if (tile.classList.contains('used')) return;
  AudioManager.playSFX('sfx-word-place.mp3');
  tile.classList.add('used');
  placedWords.push({word, tile});
  const slot = document.createElement('div');
  slot.className = 'word-slot';
  slot.textContent = word;
  slot.onclick = () => removeWord(slot, tile, word);
  document.getElementById('wordSlots').appendChild(slot);
  checkPhrase();
}
function removeWord(slot, tile, word) {
  AudioManager.playSFX('sfx-word-remove.mp3');
  slot.remove();
  tile.classList.remove('used');
  placedWords = placedWords.filter(w => !(w.word === word && w.tile === tile));
  checkPhrase();
}
function checkPhrase() {
  const current = placedWords.map(w => w.word);
  if (current.length === TARGET_PHRASE.length && current.every((w,i) => w === TARGET_PHRASE[i])) {
    const msg = document.getElementById('concertSuccess');
    msg.innerHTML = '"Brownies and carrot cake."';
    msg.classList.add('visible');
    AudioManager.playSFX('sfx-puzzle-complete.mp3');
    setTimeout(() => {
      showDialog(CONTENT.scene5.success_dialog, () => {
        addInventoryItem(3);
        showMemoryNote(CONTENT.scene5.memory_note, 5, () => {
          document.getElementById('concertNext').style.display = 'inline-block';
        });
      }, 's5-success');
    }, 400);
  } else {
    document.getElementById('concertSuccess').classList.remove('visible');
  }
}

// ==================== SCENE 6: LOVE LETTER ====================
function initLoveLetter() {
  const letter = document.getElementById('loveLetter');
  letter.innerHTML = '';
  // Build paragraphs
  CONTENT.scene6.love_letter_paragraphs.forEach(text => {
    const p = document.createElement('p');
    p.textContent = text;
    letter.appendChild(p);
  });
  // Add signoff
  const signoff = document.createElement('div');
  signoff.className = 'signoff';
  signoff.textContent = CONTENT.scene6.signoff;
  letter.appendChild(signoff);

  const elements = letter.querySelectorAll('p, .signoff');
  elements.forEach((el, i) => {
    setTimeout(() => el.classList.add('visible'), 500 + i * 600);
  });
  setTimeout(() => startHearts(), 500 + elements.length * 600 + 400);
}

function startHearts() {
  AudioManager.playSFX('sfx-hearts.mp3');
  const container = document.getElementById('heartsContainer');
  const symbols = ['\u2665','\u2764'];
  function dropHeart() {
    const h = document.createElement('div');
    h.className = 'falling-heart';
    h.textContent = symbols[Math.floor(Math.random()*symbols.length)];
    h.style.left = Math.random()*100+'%';
    h.style.fontSize = (0.8+Math.random()*0.8)+'rem';
    h.style.animationDuration = (4+Math.random()*4)+'s';
    container.appendChild(h);
    setTimeout(() => h.remove(), 9000);
  }
  for (let i = 0; i < 8; i++) setTimeout(dropHeart, i*300);
  setInterval(() => { if (currentScene === 6) dropHeart(); }, 800);
  const colors = ['#6b1d2a','#c9a84c','#e2c97e','#8b3a4a'];
  for (let i = 0; i < 20; i++) {
    setTimeout(() => {
      const p = document.createElement('div');
      p.className = 'confetti-piece';
      p.style.left = Math.random()*100+'%';
      p.style.background = colors[Math.floor(Math.random()*colors.length)];
      p.style.width = (4+Math.random()*6)+'px';
      p.style.height = (4+Math.random()*6)+'px';
      p.style.borderRadius = Math.random()>0.5?'50%':'0';
      p.style.animationDuration = (3+Math.random()*4)+'s';
      container.appendChild(p);
      setTimeout(() => p.remove(), 8000);
    }, i*150);
  }
}

// ==================== UTILITIES ====================
function shuffle(arr) {
  for (let i = arr.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

// ==================== CAPTCHA ====================
(function initCaptcha() {
  const grid = document.getElementById('captchaGrid');
  const indices = [1,2,3,4,5,6,7,8,9];
  // Shuffle for variety
  for (let i = indices.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [indices[i], indices[j]] = [indices[j], indices[i]];
  }
  indices.forEach(n => {
    const cell = document.createElement('div');
    cell.className = 'captcha-cell';
    cell.innerHTML = '<img src="assets/captchas/captcha-' + n + '.png" alt="Photo"><div class="captcha-check"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>';
    cell.onclick = () => {
      cell.classList.toggle('selected');
      document.getElementById('captchaError').style.display = 'none';
    };
    grid.appendChild(cell);
  });
})();

function verifyCaptcha() {
  const cells = document.querySelectorAll('.captcha-cell');
  const allSelected = [...cells].every(c => c.classList.contains('selected'));
  if (allSelected) {
    document.getElementById('captchaOverlay').style.display = 'none';
    AudioManager.init();
    AudioManager.playMusic(1);
  } else {
    document.getElementById('captchaError').style.display = 'block';
  }
}

// Prevent double-tap zoom on iOS
document.addEventListener('touchend', function(e) {
  const t = e.target.closest('.start-btn,.letter-tile,.song-option,.hidden-item,.word-tile,.word-slot,.shard,.hud-btn,.next-btn,.journal-close,.phone-close,.memory-dismiss,#dialogBox');
  if (t) { e.preventDefault(); t.click(); }
}, {passive: false});
</script>
</body>
</html>
